// This is your Prisma schema file for AfyaBook - Tanzanian Clinic Appointment System
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// PATIENTS
// ============================================================================
// Primary entity - patients are identified by phone number since email
// penetration is low in Tanzania. One patient can visit multiple clinics.

model Patient {
  id                String   @id @default(uuid())
  phoneNumber       String   @unique @map("phone_number") // E.164 format: +255XXXXXXXXX
  firstName         String   @map("first_name")
  lastName          String   @map("last_name")
  dateOfBirth       DateTime? @map("date_of_birth") // Optional for privacy
  gender            String? // 'M', 'F', or 'O'
  language          String   @default("sw") // 'sw' (Swahili), 'en' (English)
  preferredChannel  String   @default("SMS") @map("preferred_channel") // 'SMS', 'WHATSAPP', or 'BOTH'
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  appointments Appointment[]
  smsLogs      SmsLog[]

  @@index([phoneNumber]) // Fast lookup by phone
  @@index([createdAt])   // For recent patient queries
  @@map("patients")
}

// ============================================================================
// CLINICS
// ============================================================================
// Medical facilities with their operating schedules stored as JSON
// to handle complex weekly schedules flexibly.

model Clinic {
  id          String   @id @default(uuid())
  name        String   // Clinic display name
  phoneNumber String   @map("phone_number") // Main contact number
  address     String?  // Physical location
  region      String   // e.g., "Dar es Salaam", "Arusha"
  isActive    Boolean  @default(true) @map("is_active")
  
  // Operating hours stored as JSON:
  // {
  //   "monday": {"open": "08:00", "close": "17:00", "slots": ["08:00", "08:30", ...]},
  //   "tuesday": {...},
  //   ...
  // }
  operatingHours String @map("operating_hours")
  
  timezone    String   @default("Africa/Dar_es_Salaam")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  staff        Staff[]
  slots        AppointmentSlot[]
  appointments Appointment[]
  smsLogs      SmsLog[]

  @@index([region])      // Filter by region
  @@index([isActive])    // Active clinic queries
  @@map("clinics")
}

// ============================================================================
// STAFF
// ============================================================================
// Medical personnel (doctors, nurses, specialists) assigned to clinics.
// Each staff member belongs to one clinic but can have multiple slots.

model Staff {
  id           String   @id @default(uuid())
  clinicId     String   @map("clinic_id")
  firstName    String   @map("first_name")
  lastName     String   @map("last_name")
  phoneNumber  String   @map("phone_number")
  role         String   // 'doctor', 'nurse', 'specialist', 'admin'
  specialization String? // e.g., 'general', 'pediatrics', 'maternity'
  licenseNumber String? @map("license_number") // Medical license
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  clinic Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  slots  AppointmentSlot[]

  @@index([clinicId])    // Staff by clinic
  @@index([role])        // Filter by role
  @@index([isActive])    // Active staff queries
  @@map("staff")
}

// ============================================================================
// APPOINTMENT SLOTS
// ============================================================================
// Pre-defined time slots that can be booked. Slots are created in advance
// based on clinic operating hours and staff availability. When a slot is
// booked, it's marked unavailable. If cancelled, it becomes available again.

model AppointmentSlot {
  id          String    @id @default(uuid())
  clinicId    String    @map("clinic_id")
  staffId     String    @map("staff_id")
  slotDate    DateTime  @map("slot_date") // Date only (time stripped)
  startTime   String    @map("start_time") // "HH:MM" format
  endTime     String    @map("end_time")   // "HH:MM" format
  isAvailable Boolean   @default(true) @map("is_available")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  clinic      Clinic       @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  staff       Staff        @relation(fields: [staffId], references: [id], onDelete: Cascade)
  appointment Appointment?

  @@index([clinicId, slotDate])      // Find slots by clinic and date
  @@index([staffId, slotDate])       // Find slots by staff and date
  @@index([slotDate, isAvailable])   // Find available slots by date
  @@index([isAvailable])             // Quick filter for available slots
  @@map("appointment_slots")
}

// ============================================================================
// APPOINTMENTS
// ============================================================================
// The actual bookings made by patients. Tracks the full lifecycle from
// booking through completion or cancellation.

model Appointment {
  id                      String           @id @default(uuid())
  slotId                  String           @unique @map("slot_id")
  patientId               String           @map("patient_id")
  clinicId                String           @map("clinic_id")
  status                  AppointmentStatus @default(BOOKED)
  appointmentType         String           @default("general") @map("appointment_type") // 'general', 'followup', 'emergency'
  notes                   String?          // Reason for visit or doctor notes
  
  // Legacy reminder fields (deprecated - kept for backwards compatibility)
  reminderSent            Boolean          @default(false) @map("reminder_sent")
  reminderSentAt          DateTime?        @map("reminder_sent_at")
  
  // New reminder system fields
  reminder24hSent         Boolean          @default(false) @map("reminder_24h_sent")
  reminder24hSentAt       DateTime?        @map("reminder_24h_sent_at")
  reminder24hFailed       Boolean          @default(false) @map("reminder_24h_failed")
  reminder24hError        String?          @map("reminder_24h_error")
  
  reminderSameDaySent     Boolean          @default(false) @map("reminder_same_day_sent")
  reminderSameDaySentAt   DateTime?        @map("reminder_same_day_sent_at")
  reminderSameDayFailed   Boolean          @default(false) @map("reminder_same_day_failed")
  reminderSameDayError    String?          @map("reminder_same_day_error")
  
  checkedInAt             DateTime?        @map("checked_in_at")
  completedAt             DateTime?        @map("completed_at")
  cancelledAt             DateTime?        @map("cancelled_at")
  cancellationReason      String?          @map("cancellation_reason")
  createdAt               DateTime         @default(now()) @map("created_at")
  updatedAt               DateTime         @updatedAt @map("updated_at")

  // Relations
  slot    AppointmentSlot @relation(fields: [slotId], references: [id], onDelete: Restrict)
  patient Patient         @relation(fields: [patientId], references: [id], onDelete: Cascade)
  clinic  Clinic          @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@index([patientId])                                      // Patient appointment history
  @@index([clinicId, status])                               // Clinic appointment management
  @@index([status])                                         // Filter by status
  @@index([createdAt])                                      // Recent appointments
  @@index([reminder24hSent, reminder24hFailed])            // 24h reminder queries
  @@index([reminderSameDaySent, reminderSameDayFailed])    // Same-day reminder queries
  @@map("appointments")
}

enum AppointmentStatus {
  BOOKED       // Initial state when slot is reserved
  CONFIRMED    // Patient confirmed via SMS/call
  REMINDER_SENT // Reminder SMS dispatched
  CHECKED_IN   // Patient arrived at clinic
  COMPLETED    // Appointment finished successfully
  CANCELLED    // Cancelled by patient or clinic
  NO_SHOW      // Patient didn't show up
}

// ============================================================================
// SMS LOGS
// ============================================================================
// Complete audit trail of every SMS sent. Critical for debugging delivery
// issues, cost tracking, and regulatory compliance.

model SmsLog {
  id              String    @id @default(uuid())
  messageId       String?   @unique @map("message_id") // Twilio message SID
  patientId       String?   @map("patient_id")
  clinicId        String?   @map("clinic_id")
  phoneNumber     String    @map("phone_number") // Recipient number
  messageType     SmsType   @map("message_type")
  messageBody     String    @map("message_body")
  status          SmsStatus @default(PENDING)
  twilioResponse  String?   @map("twilio_response") // Full API response
  errorCode       String?   @map("error_code")
  errorMessage    String?   @map("error_message")
  sentAt          DateTime? @map("sent_at")
  deliveredAt     DateTime? @map("delivered_at")
  costUsd         Float?    @map("cost_usd") // Cost in USD for tracking
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  patient Patient? @relation(fields: [patientId], references: [id], onDelete: SetNull)
  clinic  Clinic?  @relation(fields: [clinicId], references: [id], onDelete: SetNull)

  @@index([phoneNumber])            // Lookup by recipient
  @@index([patientId])              // Patient SMS history
  @@index([messageType])            // Filter by type
  @@index([status])                 // Failed message queries
  @@index([createdAt])              // Recent SMS
  @@index([sentAt])                 // Time-based reports
  @@map("sms_logs")
}

enum SmsType {
  BOOKING_CONFIRMATION    // Initial booking confirmation
  REMINDER_24H           // 24-hour reminder
  REMINDER_1H            // 1-hour reminder
  CANCELLATION           // Cancellation notification
  RESCHEDULE             // Reschedule confirmation
  GENERAL                // General communication
  CHECK_IN_CONFIRMATION  // Checked in confirmation
}

enum SmsStatus {
  PENDING     // Queued but not yet sent
  SENT        // Accepted by Twilio
  DELIVERED   // Confirmed delivered to handset
  FAILED      // Failed to send
  UNDELIVERED // Rejected by carrier
}

// ============================================================================
// WAITLIST
// ============================================================================
// Queue for patients when slots are full. Automatically fills cancellations.

model Waitlist {
  id                String   @id @default(uuid())
  patientId         String   @map("patient_id")
  clinicId          String   @map("clinic_id")
  preferredDate     DateTime @map("preferred_date") // Date patient wants
  preferredTimeSlot String?  @map("preferred_time_slot") // e.g., 'morning', 'afternoon', or specific time
  appointmentType   String   @default("general") @map("appointment_type")
  staffId           String?  @map("staff_id") // Preferred doctor (optional)
  priority          Int      @default(0) // Higher = more urgent
  status            WaitlistStatus @default(WAITING)
  notes             String?  // Reason for visit or special requests
  filledAt          DateTime? @map("filled_at")
  filledSlotId      String?  @map("filled_slot_id")
  notifiedAt        DateTime? @map("notified_at")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  patient Patient         @relation(fields: [patientId], references: [id], onDelete: Cascade)
  clinic  Clinic          @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  staff   Staff?          @relation(fields: [staffId], references: [id], onDelete: SetNull)
  filledSlot AppointmentSlot? @relation(fields: [filledSlotId], references: [id], onDelete: SetNull)

  @@index([clinicId, status, preferredDate]) // Find waiting patients by clinic and date
  @@index([patientId])                       // Patient waitlist history
  @@index([status, priority])                // Process by priority
  @@index([createdAt])                       // Recent waitlist entries
  @@map("waitlist")
}

enum WaitlistStatus {
  WAITING    // Patient is waiting for a slot
  NOTIFIED   // Slot found, patient notified
  CONFIRMED  // Patient confirmed they will take the slot
  EXPIRED    // Patient didn't respond in time
  CANCELLED  // Patient cancelled their waitlist entry
}

// ============================================================================
// CRON LOGS
// ============================================================================
// Monitoring and audit trail for automated cron jobs. Tracks each run,
// success rates, and failures for operational visibility.

model CronLog {
  id              String     @id @default(uuid())
  jobName         String     @map("job_name") // e.g., 'send-reminders'
  startedAt       DateTime   @map("started_at")
  completedAt     DateTime?  @map("completed_at")
  status          CronStatus @default(RUNNING)

  // Execution details
  appointmentsChecked   Int      @default(0) @map("appointments_checked")
  remindersSent         Int      @default(0) @map("reminders_sent")
  remindersFailed       Int      @default(0) @map("reminders_failed")
  retriesAttempted      Int      @default(0) @map("retries_attempted")

  // Error tracking
  errorMessage    String?    @map("error_message")
  errorStack      String?    @map("error_stack")

  // Performance metrics
  durationMs      Int?       @map("duration_ms")

  // Request metadata (for debugging)
  requestId       String?    @map("request_id") // Vercel cron request ID
  triggeredBy     String     @default("cron") @map("triggered_by") // 'cron' | 'manual' | 'test'

  createdAt       DateTime   @default(now()) @map("created_at")

  @@index([jobName, startedAt])     // Recent runs by job
  @@index([status])                 // Failed job queries
  @@index([createdAt])              // Time-based reports
  @@index([startedAt])              // Scheduling queries
  @@map("cron_logs")
}

enum CronStatus {
  RUNNING   // Job is currently executing
  SUCCESS   // Completed successfully
  PARTIAL   // Some reminders failed but job completed
  FAILED    // Job failed completely
  TIMEOUT   // Job timed out
}
